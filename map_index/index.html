<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <script src="js/d3.v3.min.js"></script>
    <script src="js/colorbrewer.js"></script>
    <style>
      BODY {
        font-family : Ubuntu, sans;
        font-size: 10px;
      }
      P {
        width: 500px;
        text-align: justify;
      }
      path {
        /*fill: rgb(230, 230, 200);*/
        stroke-width: 0.5px;
        stroke: rgb(50, 50, 50);
      }
      text {
        fill: rgb(50, 50, 50);
      }
    </style>
  </head>
  <body>

    <div id="vis">
    </div>

   
    <script>
      var height = 600;
      var width = 500;
      var nmax   = 9;
      var cscale = colorbrewer.RdYlGn[nmax];
      var variable = "index_krijg"

      var data;
      var vmin, vmax;
      function quantize(d, nmax) {
        for (var i = 0; i < data.length; ++i) {
          if (data[i].buurt_code == d.properties.STATCODE) {
            var val = parseFloat(data[i][variable]);
            return Math.floor((val - vmin)*0.99999/(vmax - vmin) * nmax);
            /*return Math.floor(Math.sqrt((data[i][variable]-vmin)*0.999)/Math.sqrt(vmax-vmin)*nmax);*/
          }
        }
      }
      function quantize_color(d) {
        var i = quantize(d, nmax);
        if (i === undefined || isNaN(i)) return "#EEEEEE";
        console.log(i);
        return cscale[i];
      }
       
      var vis = d3.select("#vis").append("svg")
        .attr("width", width).attr("height", height)
      vis.append("rect").attr("class", "background").attr("width", width)
        .attr("height", height).style({"fill":"#FFFFFF"});

      d3.json("map/bu_2014.json", function(map) {

        d3.csv("data/index.csv", function(error, d) {
          data = d;
          vmin = d3.min(data, function(d) { return parseFloat(d[variable]);});
          vmax = d3.max(data, function(d) { return parseFloat(d[variable]);});
          vmax = Math.max(Math.abs(vmin-1), Math.abs(vmax-1))+1;
          vmin = -vmax+2;

          var projection = d3.geo.transverseMercator()
            .rotate([-5.38720621, -52.15517440]).scale(1).translate([0,0]);
          var path = d3.geo.path().projection(projection);
          // determine scale and translation so that we project the map inside 
          // the window we have
          var bounds = path.bounds(map);
          var scale  = .95 / Math.max((bounds[1][0] - bounds[0][0]) / width,
              (bounds[1][1] - bounds[0][1]) / height);
          var transl = [(width - scale * (bounds[1][0] + bounds[0][0])) / 2,
              (height - scale * (bounds[1][1] + bounds[0][1])) / 2];
          projection.scale(scale).translate(transl);
          // draw the map
          vis.selectAll("path").data(map.features).enter().append("path")
            .attr("d", path)
            .attr("fill", quantize_color);
        });
      });
    </script>
  </body>
</html>

